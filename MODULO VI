MODULO IV: Seguridad Avanzada y Servicios de Red

==============================================================================================================================================

Práctica 1: Cifrado GPG2 / Ubuntu

-Instalar GPG2 (GnuPG)-

sudo apt update
(Para actualizar la lista de paquetes disponibles)

sudo apt install gnupg2
(Para instalar la herramienta GnuPG 2, que incluye gpg2)

-Crear y cifrar un archivo-

mkdir directorio_seguro
(Para crear un nuevo directorio donde trabajaremos)

cd directorio_seguro
(Para entrar al directorio recién creado)

echo "Este es mi archivo secreto" > secreto.txt
(Para crear un archivo de texto llamado 'secreto.txt' con contenido)

gpg2 -c secreto.txt
(Para cifrar el archivo. Te pedirá una contraseña (passphrase) dos veces para confirmar)

ls -l
(Para listar los archivos. Verás 'secreto.txt' y el nuevo archivo cifrado 'secreto.txt.gpg')

-Intentar acceder al archivo cifrado-

cat secreto.txt.gpg
(Mostrará contenido binario ilegible, demostrando que está cifrado)

rm secreto.txt
(Para borrar el archivo original sin cifrar, por seguridad)

-Descifrar el archivo y mostrar contenido-

gpg2 -o descifrado.txt -d secreto.txt.gpg
(Para descifrar 'secreto.txt.gpg'. Te pedirá la contraseña. El contenido se guardará en 'descifrado.txt')

cat descifrado.txt
(Para mostrar el contenido del archivo ya descifrado, que debe ser "Este es mi archivo secreto")

==============================================================================================================================================

Práctica 2: IPtables y UFW / Ubuntu

-Instalar y habilitar servicios (HTTP, FTP, SSH)-

sudo apt update
(Para actualizar la lista de paquetes)

sudo apt install apache2 vsftpd openssh-server
(Para instalar el servidor web Apache, el servidor FTP vsftpd y el servidor SSH)

sudo systemctl start apache2
sudo systemctl start vsftpd
sudo systemctl start ssh
(Para iniciar los tres servicios)

ss -tlpn | grep -E ':(80|21|22)'
(Para confirmar que los puertos 80 (http), 21 (ftp) y 22 (ssh) están escuchando)

-Bloquear puertos con IPtables-

sudo ufw disable
(Importante: Deshabilitamos UFW para que no interfiera con las reglas manuales de IPtables)

sudo iptables -A INPUT -p tcp --dport 80 -j DROP
(Para añadir una regla que bloquea toda entrada TCP al puerto 80)

sudo iptables -A INPUT -p tcp --dport 21 -j DROP
(Para añadir una regla que bloquea toda entrada TCP al puerto 21)

sudo iptables -A INPUT -p tcp --dport 22 -j DROP
(Para añadir una regla que bloquea toda entrada TCP al puerto 22. Cuidado: esto bloqueará tu acceso SSH si estás conectado remotamente)

sudo iptables -L INPUT -n --line-numbers
(Para listar las reglas de la cadena INPUT y ver los bloqueos aplicados)

-Habilitar puertos nuevamente con IPtables-

sudo iptables -F
(Para 'Flush' o limpiar TODAS las reglas. Es la forma más rápida de eliminar los bloqueos y restaurar el acceso)

sudo iptables -L INPUT -n
(Para comprobar que la lista de reglas está vacía)

-Bloquear puertos con UFW (Uncomplicated Firewall)-

sudo iptables -F
(Nos aseguramos que IPtables esté limpio antes de habilitar UFW)

sudo ufw enable
(Para habilitar UFW. Preguntará confirmación, ya que puede interrumpir conexiones SSH)

sudo ufw default deny incoming
(Buena práctica: Bloquear todo lo entrante por defecto)

sudo ufw default allow outgoing
(Buena práctica: Permitir todo lo saliente por defecto)

sudo ufw deny 80/tcp
(Para bloquear el puerto 80 usando la sintaxis de UFW)

sudo ufw deny 21/tcp
(Para bloquear el puerto 21)

sudo ufw deny 22/tcp
(Para bloquear el puerto 22. UFW suele tener una regla 'allow SSH' por defecto, esto la sobreescribe)

sudo ufw status numbered
(Para mostrar el estado y las reglas de UFW con números)

-Habilitar puertos nuevamente con UFW-

sudo ufw allow 80/tcp
(Para permitir el tráfico al puerto 80)

sudo ufw allow 21/tcp
(Para permitir el tráfico al puerto 21)

sudo ufw allow 22/tcp
(Para permitir el tráfico al puerto 22, o usar 'sudo ufw allow ssh')

sudo ufw status
(Para comprobar el estado final)

==============================================================================================================================================

Práctica 3: Instalación de IDS Snort / Ubuntu

-Descargar e instalar Snort-

sudo apt update
(Para actualizar los paquetes)

sudo apt install snort -y
(Para instalar Snort y aceptar las dependencias. Durante la instalación, te pedirá la red local (HOME_NET), ej: 192.168.1.0/24)

ip a
(Para identificar el nombre de tu interfaz de red, ej: enp0s3 o eth0)

-Crear reglas de detección de tráfico-

sudo nano /etc/snort/rules/local.rules
(Para editar el archivo de reglas locales de Snort)

(Añadir las siguientes líneas al final del archivo)
alert icmp any any -> $HOME_NET any (msg:"ALERTA: Trafico ICMP (Ping) detectado"; sid:1000001; rev:1;)
alert tcp any any -> $HOME_NET 21 (msg:"ALERTA: Trafico FTP (puerto 21) detectado"; sid:1000002; rev:1;)
alert tcp any any -> $HOME_NET 22 (msg:"ALERTA: Trafico SSH (puerto 22) detectado"; sid:1000003; rev:1;)
alert tcp any any -> $HOME_NET 80 (msg:"ALERTA: Trafico HTTP (puerto 80) detectado"; sid:1000004; rev:1;)

-Validar y ejecutar el IDS-

sudo snort -T -c /etc/snort/snort.conf
(Para probar la configuración de Snort. Debe terminar con "Snort successfully validated configuration!")

sudo snort -A console -q -c /etc/snort/snort.conf -i <tu_interfaz>
(Ej: sudo snort -A console -q -c /etc/snort/snort.conf -i enp0s3)
(Para ejecutar Snort en modo consola, mostrando alertas en tiempo real. Reemplaza <tu_interfaz> con la obtenida de 'ip a')

-Realizar pruebas desde la máquina host-

(Mientras Snort corre en la VM, abre una terminal en tu máquina Host (Windows/Mac/Linux) y ejecuta:)

ping <IP_de_la_VM>
(Verás la alerta ICMP en la consola de Snort)

ssh usuario@<IP_de_la_VM>
(Verás la alerta SSH. No necesitas completar el login)

curl http://<IP_de_la_VM>
(Verás la alerta HTTP)

(Para FTP, si tienes un cliente:)
ftp <IP_de_la_VM>
(O puedes usar telnet para probar la conexión:)
telnet <IP_de_la_VM> 21
(Verás la alerta FTP en Snort)

==============================================================================================================================================

Práctica 4: Configurar 2FA con Google Authenticator (Módulo PAM) para SSH

-Instalar Google Authenticator (PAM)-

sudo apt update
(Para actualizar paquetes)

sudo apt install libpam-google-authenticator
(Para instalar el módulo PAM de Google Authenticator)

-Configurar Google Authenticator para el usuario-

google-authenticator
(Ejecuta este comando con el usuario que usas para SSH, NO como root)

(Responde a las preguntas:)
Make tokens time-based? (y/n) y
(Se mostrará un código QR. Escanéalo con la app Google Authenticator en tu teléfono)
(Guarda los códigos de emergencia en un lugar seguro)
Update your "/home/usuario/.google_authenticator" file? (y/n) y
Disallow multiple uses of the same token? (y/n) y
Increase time skew window? (y/n) n
Enable rate-limiting? (y/n) y

-Configurar PAM para usar Google Authenticator-

sudo nano /etc/pam.d/sshd
(Para editar la configuración PAM del servicio SSH)

(Añade la siguiente línea AL FINAL del archivo:)
auth required pam_google_authenticator.so

-Configurar SSH para solicitar 2FA-

sudo nano /etc/ssh/sshd_config
(Para editar la configuración del demonio SSH)

(Busca la línea 'ChallengeResponseAuthentication' y cámbiala de 'no' a 'yes':)
ChallengeResponseAuthentication yes

(Asegúrate también de que 'PasswordAuthentication' esté en 'yes':)
PasswordAuthentication yes

-Reiniciar SSH y realizar la demostración-

sudo systemctl restart sshd
(Para aplicar los cambios reiniciando el servicio SSH)

-Demostración desde el Host-

ssh tu_usuario@<IP_de_la_VM>
(Inicia sesión desde tu máquina host. El servidor ahora te pedirá:)
Password:
(Ingresa tu contraseña de Ubuntu)
Verification code:
(Ingresa el código de 6 dígitos de la app Google Authenticator)

(Si ambos son correctos, accederás al sistema)

==============================================================================================================================================
Jose Miguel García Báez - 20250755


CIFRAR Y DESIFRAR UN ARCHIVO USANDO GPG2
Sudo apt install gnupg (para instalar el programa)
Crear un archivo de texto con nano
Gpg -c Texto.txt (para cifrar un archivo individual con contraseña)
Borrar el archivo original , intentar leer el archivo cifrado con cat
Gpg -o Texto.txt -d Texto.txt.gpg (para descifrar un archivo cifrado , en este caso
no se nos pide la contraseña ya que la contraseña se guardo temporalmente en el
sistema)
Gpgconf – reload gpg-agent (para borrar la contraseña , en este caso volver a
aplicar el ejemplo anterior para confirmar que si se pedirá la contraseña)


CIFRAR Y DESIFRAR ARCHIVOS CON CLAVES
Gpg –full-generate-key (Para generar dos claves de gpg)
-Seleccionar tipo de clave deseado (1 recomendando)
-Seleccionar longitud de bits (4096 recomendado)
-Seleccionar el periodo de validez de clave (0 recomendado)
-Procedemos a colocar nuestra contraseña
Gpg –list-keys (para ver las claves publicas que hay en el sistema)
Gpg –list-secret-keys (Para ver las claves privadas que hay en el sistema)
Gpg –encrypt --recipient ¨llave publica¨ Texto.txt (Para cifrar el archivo con
nuestra llave publi
Gpgconf –reload gpg-agent
Gpg –list-keys
Gpg –output Texto.txt –decrypt Texto.txt.gpg (para descifrar un archivo el cual fue
cifrado con llave publica y privada)


EXTRAER CLAVES
Gpg –list-keys
Gpg –output clave_publica.gpg –export “Llave publica” (para exportar la clave
publica)
Gpg –list-secret-keys
Gpg –output clave_privada.gpg –export-secret-keys “Llave privada” (para exportar
la clave privada)
Gpg –output subclave.gpg –export-secret-subkeys “Llave privada” (para exportar
las subclaves)


BORRAR LAS CLAVES , PARA LUEGO IMPORTARLA
Gpg –list-keys
Gpg –delete-secret-key (llave privada) (para borrar la clave privada)
Gpg –delete-key (llave publica) (para borrar la clave publica)
Gpg –list-keys (en este caso es para confirmar que se hayan borrado las claves)
Gpg –import clave_publica.gpg (para importar nuestra clave publica)
Gpg –import clave_privada.gpg (para importar nuestra clave privada)
Gpg –import subclave.gpg (para importar las subclaves)
Si realizo un gpg –list-keys podremos confirmar que ya tenemos nuestras claves
Gpg –output Texto.txt –decrypt Texto.txt.gpg (para descifrar un archivo y así
comprobar que se importaron correctamente las claves)


EXTRAER EL MD5, SHA1 Y SHA256 DE UN TEXTO Y DE UN ARCHIVO
Primero crearemos dos archivos “Archivo1” y “Archivo2” ambos diciendo HOLA
Md5sum Archivo1 (para ver el hash con md5 del archivo1)
Md5sum Archivo2 (para ver el hash con md5 del archivo2)
Veremos que el hash de ambos archivos es el mismo ya que tienen el mismo
contenido
Luego en “Archivo2” cambiar HOLA por HOLAA
Md5sum Archivo1 (para ver el hash con md5 del archivo1)
Md5sum Archivo2 (para ver el hash con md5 del archivo2)
Y veremos que el hash de ambos archivos es diferente ya que tienen contenido
diferente
Md5sum Archivo1 > hash.txt (para extrar el contenido del hash a un archivo txt
llamado hash.txt)
Md5sum Archivo2 >> hash.txt (para extrar el contenido del hash al mismo archivo
txt anteriormente)
Sha1sum “archivo” (para ver el hash con SHA1 del archivo)
Sha1sum Archivo1 >> hash.txt (para extrar el contenido del hash a un archivo txt
llamado hash.txt)
Sha1sum Archivo2 >> hash.txt (para extrar el contenido del hash al mismo archivo
txt anteriormente)
Sha256sum “archivo” (para ver el hash con SHA1 del archivo)
Sha256sum Archivo1 >> hash.txt (para extrar el contenido del hash a un archivo
txt llamado hash.txt)
Sha256sum Archivo2 >> hash.txt (para extrar el contenido del hash al mismo
archivo txt anteriormente)


CONFIGURAR UN MODULO PAM PARA QUE BLOQUEE EL LOGIN DE SSH TRAS 3 INTENTOS FALLIDOS
Sudo apt install libpam-pwquality -y (para instalar los módulos pam)
Sudo apt install libpwquality-tools (para instalar las diferentes herramientas
utilizadas en los módulos)
Cd /etc/pam.d/ (para movernos al directorio donde podremos continuar la
configuración del servicio PAM)
Sudo nano common-password (aquí podemos ver los parámetros que debe cumplir
nuestra contraseña por ejemplo la longitud mínima) por ejemplo aquí podemos
agregar los siguientes parámetros
Minlen= x (para que el mínimo de caracteres de la contraseña sea X)
Minclass=x (Los tipos de caracteres diferentes que se deben incluir en la contra ,
sea dígitos , mayúsculas , minúsculas etc)
Dcredit= -X (es obligatorio que la contraseña tengo por lo menos un numero)
Ocredit= -X (es obligatorio que la contraseña tenga un signo de puntuación)
Ucredit= -X (Es obligatorio que la contraseña tenga mayúsculas)
Passwd jose20250755 (para crear una nueva contraseña acorde con los nuevos
parámetros que hemos creado)
Passwd cupsadmin


BLOQUEAR LOGIN CON INTENTOS FALLIDOS
Sudo nano common-account (para cofingurar el archivo de acceder a las cuentas)
Aquí iremos a la línea # here are the per-package modules , y debajo agregamos:
Account required pam_faillock.so (para que se requiera utilizar faillock a la hora
de loguearnos)
Sudo nano common-auth (para configurar el archivo de los procesos de
autenticación)
Aquí iremos a la línea # here are the per-package modules , y debajo agregamos:
Auth required pam_faillock.so preauth deny=3 unlock_time=60 (aqui le estamos
dejando claro al Sistema que debe utilizar faillock para la autentificación de
usuario, si el usuario loguea 3 mal incorrectamente , el logeo se bloqueara por 60
segundos)
Ahora iremos a la línea #heres the failback if no module succeeds , iremo a la linea
de abajo (auth requisite pam_deny.so) y agregaremos (#) al inicio , abajo agrego:
Auth [default=die] pam_faillock.so authfail
Faillock –user “nombre” (para ver la información de los logueos de un usuario)
Faillock –user “nombre” –reset (para desbloquear un usuario luego de haber sido
bloqueado)


BLOQUEAR Y DESBLOQUEAR EL ACCESO A PUERTOS COMUNES USANDO IPTABLES (22,80,21)
Para esta demostraccion primero mostraremos los servicios de http y ssh
funcionando , primero entramos al servidor con nuestra ip y luego nos logeamos
con ssh para comprobar que efectivamente ambos servicios funcionan de manera
correcta
Sudo iptables -l –line-numbers (aqui Podemos ver una lista de lo que hemos hecho
con el iptables)
Sudo iptables -A INPUT -p tcp –dport 80 -j DROP (para desactivar el puerto 80)
Sudo iptables -A INPUT -p tcp –dport 21 -j DROP (para desactivar el puerto 21)
Sudo iptables -A INPUT -p tcp –dport 22-j DROP (para desactivar el puerto 22)
Luego de bloquear ambos puertos , debemos intentar acceder al servidor la ip para
que se demuestre que efectivamente ya no carga porque el puerto 80 fue bloqueado
, luego haremos lo mismo con el ssh y tampoco veremos que funcione porque el
puerto 22 tambien se encuentra bloqueado
Sudo iptables -A INPUT -p tcp –dport 80 -j ACCEPT (para desbloquear el puerto
80)
Sudo iptables -A INPUT -p tcp –dport 21 -j ACCEPT (para desbloquear el puerto
21)
Sudo iptables -A INPUT -p tcp –dport 22-j ACCEPT (para desbloquear el puerto
22)
Sudo iptables -D INPUT 1 (Para eliminar las reglas en las cuales bloqueamos los
puertos)
Luego de desbloquearlos los puertos , debemos hacer la prueba de acceder al
servidor y al ssh para ver si funcionan de manera correcta


ACTIVAR Y DESACTIVAR PUERTOS MEDIANTE EL FIREWALL
(Antes de iniciar este proceso es recomendable borrar todas las reglas que hicimos
anteriormente con el iptables)
Sudo ufw status verbose (para verificar el estatus de nuestro firewall)
Sudo ufw enable (para activarlo en caso de que estuviera inactivo)
Sudo ufw deny 80/tcp (para bloquear el puerto 80)
Sudo ufw deny 22/tcp (para bloquear el puerto 22)
Sudo ufw deny 21/tcp (para bloquear el puerto 21)
Sudo ufw status numbered (para ver el status de los puertos)
Luego de bloquear ambos puertos , debemos intentar acceder al servidor la ip para
que se demuestre que efectivamente ya no carga porque el puerto 80 fue bloqueado
, luego haremos lo mismo con el ssh y tampoco veremos que funcione porque el
puerto 22 tambien se encuentra bloqueado
Sudo ufw allow 80/tcp (para activar el puerto 80)
Sudo ufw allow 22/tcp (para activar el puerto 22)
Sudo ufw allow 21/tcp (para activar el puerto 21)



INSTALAR SNORT Y CONFIGURARLO PARA QUE DETECTE TRAFICO ENTRANTE
sudo apt install snort -y (para instalar el servicio de snort)
Al iniciar la configuración , pondremos nuestro rango de red y su debido prefijo de
mascara de subred, en este caso fue 192.168.0.0/24
Sudo nano /etc/snort/snort.conf (para entrar al archivo de configuración de snort)
Iremos a la línea que dice ipvar HOME_NET any, borraremos el any pondremos
nuestro rango de ip y el prefijo de subred, en este caso es 192.168.0.0/24
Iremos a la línea #include $RULE_PATH/web-activeex.rules y agregaremos lo
siguiente al final:
Include $RULE_PATH/local.rules (ya Podemos salir de la configuración)
Sudo nano /etc/snort/rules/local.rules (aquí podremos agregar las reglas del trafico
que vamos a detectar)
Agregamos las siguientes reglas:
alert icmp any any -> $HOME_NET any (msg:"Trafico ICMP detectado"; sid:
180001; rev:1;) (Basicamente esto nos mandara una alerta que dira ¨TRAFICO
ICMP DETECTADO¨ cuando hagamos uso del protocolo ICMP , es decir cuando
hagamos un ping)
alert tcp any any -> $HOME_NET 21 (msg:"Trafico FTP detectado"; sid: 100002;
rev: 1;)
alert tcp any any -> $HOME_NET 22 (msg:"Trafico SSH detectado"; sid: 108003;
rev:1;)
alert tcp any any -> $HOME_NET 80 (msg: "Trafico HTTP detectado"; sid:
100004; rev: 1;)
Ya Podemos salir de la configuración con control o , enter y control x
Sudo snort -T -i enp0s3 -c /etc/snort/snort.conf (Para probar si la configuración
esta correcta)
Sudo snort -i enp0s3 -c /etc/snort/snort.conf (para Validar la configuración del
snort en nuestro sistema)
EN OTRA TERMINAL EJECUTAMOS LO SIGUIENTE
Sudo tail -f /var/log/snort/snort.alert.fast (esto se utiliza para poder monitorear en
tiempo real el archivo de alertas de snort)
EN CMD EJECUTAMOS LO SIGUIENTE
Ping ip del servidor(para hacer un ping a nuestra maquina virtual y así
comprobemos como llega la alerta del ICMP con snort)
Ssh jose20250755@ip_del servidor (para acceder con ssh y así comprobemos
como llega la alerta del trafico ssh en snort)
Telnet ip del servidor 21 (para utilizar telnet con el puerto 21 y así comprobemos
como llega la alerta del trafico ftp en snort)
Curl http://ip del servidor (para utilizar http con el puerto 80 y así comprobemos
como llega la alerta del trafico http en snort)
